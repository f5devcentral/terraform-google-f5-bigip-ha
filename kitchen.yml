# NOTE: This test-kitchen file contains ERB code to cut-down on boilerplate; YAML
# linters will complain!
# yamllint disable
<%
require 'open3'
require 'json'

# Fall back to current time and known location for report files if not present
# in ENV
report_dir = ENV['REPORT_DIR'] || 'test/reports'
report_ts = ENV['REPORT_TS'] || Time.now.strftime('%Y-%m-%d-%H-%M-%S')

# Parse the outputs of the test harness
tf_output, rc = Open3.capture2('terraform -chdir=test/setup output -json')
if rc != 0
  abort 'Failed to capture Terraform output from test/setup'
end
harness_outputs = JSON.parse(tf_output).map { |k,v| [k, v['value']] }.to_h

# The list of BIG-IP versions to test; all are currently using PAYG Good/25Mbps
bigip_versions = [
  {
    :version => '16.1.2.1',
    :image => 'projects/f5-7626-networks-public/global/images/f5-bigip-16-1-2-1-0-0-10-payg-good-25mbps-211222200353',
  },
  {
    :version => '15.1.4',
    :image => 'projects/f5-7626-networks-public/global/images/f5-bigip-15-1-4-0-0-47-payg-good-25mbps-210819144517',
  },
  {
    :version => '14.1.4.5',
    :image => 'projects/f5-7626-networks-public/global/images/f5-bigip-14-1-4-5-0-0-7-payg-good-25mbps-211201202553',
  },
  {
    :version => '13.1.4.1',
    :image => 'projects/f5-7626-networks-public/global/images/f5-bigip-13-1-4-1-0-0-3-payg-good-25mbps-210830172739',
  },
]
%>
---
driver:
  name: terraform
  command_timeout: 600
  verify_version: true
  variables:
    # Set the upstream module's sleep_delay to 10s; this speeds up time to
    # convergence when running a full test suite against the root module.
    # NOTE: The ha-gce test profile includes a control that fails inspec if the VMs
    # have not had enough expected time to complete onboarding.
    sleep_time: '10s'
  # This file will be generated by test/setup Terraform
  # NOTE: values in this file will override the 'variables:' section everywhere
  variable_files:
    - <%= harness_outputs['harness_tfvars'] %>

provisioner:
  name: terraform

verifier:
  name: terraform
  color: true

platforms:
  - name: local

suites:
<%
bigip_versions.each do |bigip|
  (2..8).each do |num_nics|
    test_name = sprintf('root-%s-%dnic-public-mgmt', bigip[:version].gsub(/[^A-Za-z0-9]/, '-'), num_nics)
    test_prefix = sprintf('r%s-%dn-pub', bigip[:version].gsub(/[^A-Za-z0-9]/, '-'), num_nics)
%>
  - name: <%= test_name %>
    driver:
      root_module_directory: test/fixtures/root
      variables:
        test_prefix: <%= test_prefix %>
        image: '<%= bigip[:image] %>'
        public_mgmt: 'true'
        num_nics: '<%= num_nics %>'
        machine_type: '<%= num_nics > 4 ? 'n1-standard-8' : 'n1-standard-4' %>'
    verifier:
      systems:
        - name: compute-engine
          backend: gcp
          profile_locations:
            - test/profiles/ha-gce
          reporter:
            - cli
            - documentation:<%= report_dir %>/<%= report_ts %>/<%= test_name %>-gce.txt
            - junit2:<%= report_dir %>/<%= report_ts %>/<%= test_name %>-gce.xml
            - yaml:<%= report_dir %>/<%= report_ts %>/<%= test_name %>-gce.yaml
        - name: ssh
          backend: ssh
          hosts_output: bigip_addresses
          key_files:
            - <%= harness_outputs['ssh_privkey_path'] %>
          user: admin
          profile_locations:
            - test/profiles/ha-ssh
          reporter:
            - cli
            - documentation:<%= report_dir %>/<%= report_ts %>/<%= test_name %>-ssh.txt
            - junit2:<%= report_dir %>/<%= report_ts %>/<%= test_name %>-ssh.xml
            - yaml:<%= report_dir %>/<%= report_ts %>/<%= test_name %>-ssh.yaml
        - name: atc-0
          backend: local
          attrs_outputs:
            bigip_address: bigip_address_0
            user: bigip_user
            password: bigip_password
          profile_locations:
            - https://github.com/f5devcentral/big-ip-atc-ready
          controls:
            - bigip-connectivity
            - bigip-declarative-onboarding
            - bigip-application-services
            - bigip-telemetry-streaming
            - bigip-fast
            - bigip-licensed
          reporter:
            - cli
            - documentation:<%= report_dir %>/<%= report_ts %>/<%= test_name %>-atc-0.txt
            - junit2:<%= report_dir %>/<%= report_ts %>/<%= test_name %>-atc-0.xml
            - yaml:<%= report_dir %>/<%= report_ts %>/<%= test_name %>-atc-0.yaml
        - name: atc-1
          backend: local
          attrs_outputs:
            bigip_address: bigip_address_1
            user: bigip_user
            password: bigip_password
          profile_locations:
            - https://github.com/f5devcentral/big-ip-atc-ready
          controls:
            - bigip-connectivity
            - bigip-declarative-onboarding
            - bigip-application-services
            - bigip-telemetry-streaming
            - bigip-fast
            - bigip-licensed
          reporter:
            - cli
            - documentation:<%= report_dir %>/<%= report_ts %>/<%= test_name %>-atc-1.txt
            - junit2:<%= report_dir %>/<%= report_ts %>/<%= test_name %>-atc-1.xml
            - yaml:<%= report_dir %>/<%= report_ts %>/<%= test_name %>-atc-1.yaml
<%
  end
  [
    { :name => 'ha-via-api', :short => 'cfe'},
    { :name => 'ha-via-lb', :short => 'lb'},
    { :name => 'sandwich', :short => 'blt'},
  ].each do |example|
    test_name = sprintf('ex-%s-%s-3nic-public-mgmt', example[:short], bigip[:version].gsub(/[^A-Za-z0-9]/, '-'))
    test_prefix = sprintf('%s-%s-3n-pub', example[:short], bigip[:version].gsub(/[^A-Za-z0-9]/, '-'))
%>
  - name: <%= test_name %>
    driver:
      root_module_directory: test/fixtures/examples/<%= example[:name] %>
      variables:
        test_prefix: <%= test_prefix %>
        image: '<%= bigip[:image] %>'
        public_mgmt: 'true'
        num_nics: '3'
        machine_type: 'n1-standard-4'
    verifier:
      systems:
        - name: compute-engine
          backend: gcp
          profile_locations:
            - test/profiles/ha-gce
          reporter:
            - cli
            - documentation:<%= report_dir %>/<%= report_ts %>/<%= test_name %>-gce.txt
            - junit2:<%= report_dir %>/<%= report_ts %>/<%= test_name %>-gce.xml
            - yaml:<%= report_dir %>/<%= report_ts %>/<%= test_name %>-gce.yaml
        - name: ssh
          backend: ssh
          hosts_output: bigip_addresses
          key_files:
            - <%= harness_outputs['ssh_privkey_path'] %>
          user: admin
          profile_locations:
            - test/profiles/ha-ssh
          reporter:
            - cli
            - documentation:<%= report_dir %>/<%= report_ts %>/<%= test_name %>-ssh.txt
            - junit2:<%= report_dir %>/<%= report_ts %>/<%= test_name %>-ssh.xml
            - yaml:<%= report_dir %>/<%= report_ts %>/<%= test_name %>-ssh.yaml
        - name: atc-0
          backend: local
          attrs_outputs:
            bigip_address: bigip_address_0
            user: bigip_user
            password: bigip_password
          profile_locations:
            - https://github.com/f5devcentral/big-ip-atc-ready
          controls:
            - bigip-connectivity
            - bigip-declarative-onboarding
            - bigip-application-services
            - bigip-telemetry-streaming
            - bigip-fast
            - bigip-licensed
          reporter:
            - cli
            - documentation:<%= report_dir %>/<%= report_ts %>/<%= test_name %>-atc-0.txt
            - junit2:<%= report_dir %>/<%= report_ts %>/<%= test_name %>-atc-0.xml
            - yaml:<%= report_dir %>/<%= report_ts %>/<%= test_name %>-atc-0.yaml
        - name: atc-1
          backend: local
          attrs_outputs:
            bigip_address: bigip_address_1
            user: bigip_user
            password: bigip_password
          profile_locations:
            - https://github.com/f5devcentral/big-ip-atc-ready
          controls:
            - bigip-connectivity
            - bigip-declarative-onboarding
            - bigip-application-services
            - bigip-telemetry-streaming
            - bigip-fast
            - bigip-licensed
          reporter:
            - cli
            - documentation:<%= report_dir %>/<%= report_ts %>/<%= test_name %>-atc-1.txt
            - junit2:<%= report_dir %>/<%= report_ts %>/<%= test_name %>-atc-1.xml
            - yaml:<%= report_dir %>/<%= report_ts %>/<%= test_name %>-atc-1.yaml
<%
  end
end
%>
